#include <FEHLCD.h>
#include <FEHIO.h>
#include <FEHUtility.h>
#include <FEHMotor.h>
#include <stdlib.h>
#include <stdio.h>
#include <FEHMotor.h>
#include <FEHBattery.h>
#include <FEHServo.h>

FEHMotor left_motor(FEHMotor::Motor2, 9.0);
FEHMotor right_motor(FEHMotor::Motor1, 9.0);
DigitalEncoder right_encoder(FEHIO::P1_6);
DigitalEncoder left_encoder(FEHIO::P1_4);
AnalogInputPin CDS_Sensor(FEHIO::P2_7);
FEHServo Arm_Servo(FEHServo::Servo0);

const float COUNTS_PER_INCH = 33.7408479355;
const float COLLISION_TIMEOUT = 0.5; // Time in seconds to continue driving after detecting collision

void move_forward(int percent, int inches) {
    int counts = inches * COUNTS_PER_INCH;
    right_encoder.ResetCounts();
    left_encoder.ResetCounts();

    right_motor.SetPercent(-percent);
    left_motor.SetPercent(-percent);

    int lastLeftCounts = left_encoder.Counts();
    int lastRightCounts = right_encoder.Counts();
    float stallStartTime = 0;  // Timer for collision detection

    while ((left_encoder.Counts() + right_encoder.Counts()) / 2.0 < counts) {
        int currentLeftCounts = left_encoder.Counts();
        int currentRightCounts = right_encoder.Counts();

        if (currentLeftCounts == lastLeftCounts && currentRightCounts == lastRightCounts) {
            // Only start the timer if it hasn't been started
            if (stallStartTime == 0) {
                stallStartTime = TimeNow();
            }
            // If the stall persists for COLLISION_TIMEOUT, continue for 0.5s then stop
            if (TimeNow() - stallStartTime >= COLLISION_TIMEOUT) {
                right_motor.SetPercent(-percent);
                left_motor.SetPercent(-percent);
                Sleep(0.5);
                break;
            }
        } else {
            // Reset stall timer if movement resumes
            stallStartTime = 0;
        }

        lastLeftCounts = currentLeftCounts;
        lastRightCounts = currentRightCounts;
    }

    right_motor.Stop();
    left_motor.Stop();
}

int main() 
{
    move_forward(25, 10); // Example call
}

